"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const path = require("path");
const spawn = require('cross-spawn');
const scriptsIndexHtml = `
<!-- Comment this out, *if* using differential loading or es2015 as a target in Angular 8+ -->
<script src="./assets/webcomponentsjs/custom-elements-es5-adapter.js"></script>

`;
const scriptsPolyfills = `
if (!window['customElements']) {
  const script = document.createElement('script');
  script.src = './assets/webcomponentsjs/bundles/webcomponents-sd-ce.js';
  document.writeln(script.outerHTML);
}
`;
function npmInstall(options) {
    return function (tree, context) {
        spawn.sync('npm', ['install', options.package, options.switch], { stdio: 'inherit' });
        return tree;
    };
}
function npmRun(options) {
    return function (tree, context) {
        spawn.sync('npm', ['run', options.script], { stdio: 'inherit' });
        return tree;
    };
}
exports.npmRun = npmRun;
function executeNodeScript(options) {
    const scriptName = options.script;
    return (tree, _context) => {
        spawn.sync('node', [scriptName], { stdio: 'inherit' });
    };
}
exports.executeNodeScript = executeNodeScript;
function addWebComponentsPolyfill(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign(Object.assign({}, _options), { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        const rule = schematics_1.chain([
            updateIndexHtml(_options),
            updatePolyfills(_options),
            updatePackageJson(project.root || '', _options),
            schematics_1.branchAndMerge(schematics_1.mergeWith(templateSource)),
        ]);
        const packageJson = loadPackageJson(tree);
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/custom-elements']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/custom-elements',
            }));
        }
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/webcomponentsjs']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/webcomponentsjs',
            }));
        }
        if ((!packageJson['dependencies'] || !packageJson['dependencies']['copy'])
            && (!packageJson['devDependencies'] || !packageJson['devDependencies']['copy'])) {
            const id = _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: 'copy',
            }));
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }), [id]);
        }
        else {
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }));
        }
        return rule(tree, _context);
    };
}
exports.addWebComponentsPolyfill = addWebComponentsPolyfill;
function updatePackageJson(path, _options) {
    return (tree, context) => {
        const config = loadPackageJson(tree);
        updateScripts(path, config, tree, _options);
        savePackageJson(config, tree);
        return tree;
    };
}
function updateIndexHtml(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/index.html`;
        const indexHtml = tree.read(fileName);
        if (indexHtml === null)
            throw Error('could not read index.html');
        const contentAsString = indexHtml.toString('UTF-8');
        if (contentAsString.includes('native-shim.js')) {
            console.info('Seems like, webcomponent polyfills are already referenced by index.html');
            return;
        }
        const modifiedContent = contentAsString.replace('</body>', scriptsIndexHtml + '\n</body>');
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function updatePolyfills(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/polyfills.ts`;
        const polyfillsJs = tree.read(fileName);
        if (polyfillsJs === null)
            throw Error('could not read polyfills.ts');
        const contentAsString = polyfillsJs.toString('UTF-8');
        if (contentAsString.includes('webcomponents-loader.js')) {
            console.info('Seems like, webcomponents-loader is already referenced by polyfill.js');
            return;
        }
        const modifiedContent = contentAsString + '\n\n' + scriptsPolyfills;
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options) {
    if (path) {
        path += '/';
    }
    const script = `node ${path}copy-wc-polyfill.js`;
    if (!config['scripts']) {
        config.scripts = {};
    }
    let currentScript = config.scripts['npx-build-plus:copy-assets'];
    if (!currentScript) {
        currentScript = script;
    }
    else if (!currentScript.includes(script)) {
        currentScript += ' && ' + script;
    }
    config.scripts['npx-build-plus:copy-assets'] = currentScript;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3Mvd2ViY29tcG9uZW50cy1wb2x5ZmlsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUF3STtBQUN4SSwrREFBa0U7QUFDbEUsNERBQTRGO0FBQzVGLDZCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFckMsTUFBTSxnQkFBZ0IsR0FBRzs7OztDQUl4QixDQUFBO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRzs7Ozs7O0NBTXhCLENBQUM7QUFFRixTQUFTLFVBQVUsQ0FBQyxPQUFZO0lBQzlCLE9BQU8sVUFBVSxJQUFVLEVBQUUsT0FBeUI7UUFDcEQsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUN0RixPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQTtBQUNILENBQUM7QUFFRCxTQUFnQixNQUFNLENBQUMsT0FBWTtJQUNqQyxPQUFPLFVBQVUsSUFBVSxFQUFFLE9BQXlCO1FBQ3BELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUxELHdCQUtDO0FBRUQsU0FBZ0IsaUJBQWlCLENBQUMsT0FBWTtJQUM1QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0lBQ2xDLE9BQU8sQ0FBQyxJQUFVLEVBQUUsUUFBMEIsRUFBRSxFQUFFO1FBQ2hELEtBQUssQ0FBQyxJQUFJLENBQUMs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SSxhQUFhLEdBQVcsTUFBTSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBRXpFLElBQUksQ0FBQyxhQUFhLEVBQUU7UUFDbEIsYUFBYSxHQUFHLE1BQU0sQ0FBQztLQUN4QjtTQUNJLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3hDLGFBQWEsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDO0tBQ2xDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxHQUFHLGFBQWEsQ0FBQztBQUMvRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUnVsZSwgU2NoZW1hdGljQ29udGV4dCwgVHJlZSwgYXBwbHksIHVybCwgdGVtcGxhdGUsIG1vdmUsIGJyYW5jaEFuZE1lcmdlLCBtZXJnZVdpdGgsIGNoYWluIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MnO1xyXG5pbXBvcnQgeyBnZXRXb3Jrc3BhY2UgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvY29uZmlnJztcclxuaW1wb3J0IHsgUnVuU2NoZW1hdGljVGFzaywgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzL3Rhc2tzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbmNvbnN0IHNwYXduID0gcmVxdWlyZSgnY3Jvc3Mtc3Bhd24nKTtcclxuXHJcbmNvbnN0IHNjcmlwdHNJbmRleEh0bWwgPSBgXHJcbjwhLS0gQ29tbWVudCB0aGlzIG91dCwgKmlmKiB1c2luZyBkaWZmZXJlbnRpYWwgbG9hZGluZyBvciBlczIwMTUgYXMgYSB0YXJnZXQgaW4gQW5ndWxhciA4KyAtLT5cclxuPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy93ZWJjb21wb25lbnRzanMvY3VzdG9tLWVsZW1lbnRzLWVzNS1hZGFwdGVyLmpzXCI+PC9zY3JpcHQ+XHJcblxyXG5gXHJcblxyXG5jb25zdCBzY3JpcHRzUG9seWZpbGxzID0gYFxyXG5pZiAoIXdpbmRvd1snY3VzdG9tRWxlbWVudHMnXSkge1xyXG4gIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xyXG4gIHNjcmlwdC5zcmMgPSAnLi9hc3NldHMvd2ViY29tcG9uZW50c2pzL2J1bmRsZXMvd2ViY29tcG9uZW50cy1zZC1jZS5qcyc7XHJcbiAgZG9jdW1lbnQud3JpdGVsbihzY3JpcHQub3V0ZXJIVE1MKTtcclxufVxyXG5gO1xyXG5cclxuZnVuY3Rpb24gbnBtSW5zdGFsbChvcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gZnVuY3Rpb24gKHRyZWU6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpIHtcclxuICAgIHNwYXduLnN5bmMoJ25wbScsIFsnaW5zdGFsbCcsIG9wdGlvbnMucGFja2FnZSwgb3B0aW9ucy5zd2l0Y2hdLCB7IHN0ZGlvOiAnaW5oZXJpdCcgfSk7XHJcbiAgICByZXR1cm4gdHJlZTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBucG1SdW4ob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XHJcbiAgICBzcGF3bi5zeW5jKCducG0nLCBbJ3J1bicsIG9wdGlvbnMuc2NyaXB0XSwgeyBzdGRpbzogJ2luaGVyaXQnIH0pO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZU5vZGVTY3JpcHQob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgY29uc3Qgc2NyaXB0TmFtZSA9IG9wdGlvbnMuc2NyaXB0O1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIHNwYXduLnN5bmMoJ25vZGUnLCBbc2NyaXB0TmFtZV0sIHsgc3RkaW86ICdpbmhlcml0JyB9KTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRXZWJDb21wb25lbnRzUG9seWZpbGwoX29wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuXHJcbiAgICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBfb3B0aW9ucyk7XHJcblxyXG4gICAgY29uc3QgcmVsUHJvamVjdFJvb3RQYXRoID1cclxuICAgICAgcHJvamVjdC5yb290LnJlcGxhY2UoL1teXFwvXSsvZywgJy4uJykgfHwgJyc7XHJcblxyXG4gICAgY29uc3QgdGVtcGxhdGVTb3VyY2UgPSBhcHBseSh1cmwoJy4vZmlsZXMnKSwgW1xyXG4gICAgICB0ZW1wbGF0ZSh7IC4uLl9vcHRpb25zLCByZWxQcm9qZWN0Um9vdFBhdGgsIHByb2plY3RSb290OiBwcm9qZWN0LnJvb3QgfHwgJycgfSksXHJcbiAgICAgIG1vdmUocHJvamVjdC5yb290IHx8ICcvJylcclxuICAgIF0pO1xyXG5cclxuICAgIGNvbnN0IHJ1bGUgPSBjaGFpbihbXHJcbiAgICAgIHVwZGF0ZUluZGV4SHRtbChfb3B0aW9ucyksXHJcbiAgICAgIHVwZGF0ZVBvbHlmaWxscyhfb3B0aW9ucyksXHJcbiAgICAgIHVwZGF0ZVBhY2thZ2VKc29uKHByb2plY3Qucm9vdCB8fCAnJywgX29wdGlvbnMpLFxyXG4gICAgICBicmFuY2hBbmRNZXJnZShtZXJnZVdpdGgodGVtcGxhdGVTb3VyY2UpKSxcclxuICAgICAgLy8gbnBtSW5zdGFsbCh7cGFja2FnZTogJ0B3ZWJjb21wb25lbnRzL2N1c3RvbS1lbGVtZW50cycsIHN3aXRjaDogJy0tc2F2ZSd9KSxcclxuICAgICAgLy8gbnBtSW5zdGFsbCh7cGFja2FnZTogJ2NvcHknLCBzd2l0Y2g6ICctLXNhdmUtZGV2J30pLFxyXG4gICAgXSk7XHJcblxyXG4gICAgY29uc3QgcGFja2FnZUpzb24gPSBsb2FkUGFja2FnZUpzb24odHJlZSk7XHJcblxyXG4gICAgaWYgKCFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ10gfHwgIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXVsnQHdlYmNvbXBvbmVudHMvY3VzdG9tLWVsZW1lbnRzJ10pIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XHJcbiAgICAgICAgcGFja2FnZU5hbWU6ICdAd2ViY29tcG9uZW50cy9jdXN0b20tZWxlbWVudHMnLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ10gfHwgIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXVsnQHdlYmNvbXBvbmVudHMvd2ViY29tcG9uZW50c2pzJ10pIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XHJcbiAgICAgICAgcGFja2FnZU5hbWU6ICdAd2ViY29tcG9uZW50cy93ZWJjb21wb25lbnRzanMnLFxyXG4gICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICAoIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXSB8fCAhcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddWydjb3B5J10pXHJcbiAgICAgICYmICghcGFja2FnZUpzb25bJ2RldkRlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGV2RGVwZW5kZW5jaWVzJ11bJ2NvcHknXSlcclxuICAgICkge1xyXG5cclxuICAgICAgY29uc3QgaWQgPSBfY29udGV4dC5hZGRUYXNrKG5ldyBOb2RlUGFja2FnZUluc3RhbGxUYXNrKHtcclxuICAgICAgICBwYWNrYWdlTmFtZTogJ2NvcHknLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBfY29udGV4dC5hZGRUYXNrKG5ldyBSdW5TY2hlbWF0aWNUYXNrKCducG1SdW4nLCB7IHNjcmlwdDogJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJyB9KSwgW2lkXSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgUnVuU2NoZW1hdGljVGFzaygnbnBtUnVuJywgeyBzY3JpcHQ6ICducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cycgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBydWxlKHRyZWUsIF9jb250ZXh0KTtcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVQYWNrYWdlSnNvbihwYXRoOiBzdHJpbmcsIF9vcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIGNvbnN0IGNvbmZpZyA9IGxvYWRQYWNrYWdlSnNvbih0cmVlKTtcclxuICAgIHVwZGF0ZVNjcmlwdHMocGF0aCwgY29uZmlnLCB0cmVlLCBfb3B0aW9ucyk7XHJcbiAgICBzYXZlUGFja2FnZUpzb24oY29uZmlnLCB0cmVlKTtcclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlSW5kZXhIdG1sKG9wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkgPT4ge1xyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgb3B0aW9ucyk7XHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vaW5kZXguaHRtbGA7XHJcblxyXG4gICAgY29uc3QgaW5kZXhIdG1sID0gdHJlZS5yZWFkKGZpbGVOYW1lKTtcclxuICAgIGlmIChpbmRleEh0bWwgPT09IG51bGwpXHJcbiAgICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBpbmRleC5odG1sJyk7XHJcbiAgICBjb25zdCBjb250ZW50QXNTdHJpbmcgPSBpbmRleEh0bWwudG9TdHJpbmcoJ1VURi04Jyk7XHJcblxyXG4gICAgaWYgKGNvbnRlbnRBc1N0cmluZy5pbmNsdWRlcygnbmF0aXZlLXNoaW0uanMnKSkge1xyXG4gICAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIHdlYmNvbXBvbmVudCBwb2x5ZmlsbHMgYXJlIGFscmVhZHkgcmVmZXJlbmNlZCBieSBpbmRleC5odG1sJyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtb2RpZmllZENvbnRlbnQgPSBjb250ZW50QXNTdHJpbmcucmVwbGFjZSgnPC9ib2R5PicsIHNjcmlwdHNJbmRleEh0bWwgKyAnXFxuPC9ib2R5PicpO1xyXG5cclxuICAgIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBtb2RpZmllZENvbnRlbnQpO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVQb2x5ZmlsbHMob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcbiAgICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBvcHRpb25zKTtcclxuICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7cHJvamVjdC5zb3VyY2VSb290fS9wb2x5ZmlsbHMudHNgO1xyXG5cclxuICAgIGNvbnN0IHBvbHlmaWxsc0pzID0gdHJlZS5yZWFkKGZpbGVOYW1lKTtcclxuICAgIGlmIChwb2x5ZmlsbHNKcyA9PT0gbnVsbClcclxuICAgICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBvbHlmaWxscy50cycpO1xyXG4gICAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcG9seWZpbGxzSnMudG9TdHJpbmcoJ1VURi04Jyk7XHJcblxyXG4gICAgaWYgKGNvbnRlbnRBc1N0cmluZy5pbmNsdWRlcygnd2ViY29tcG9uZW50cy1sb2FkZXIuanMnKSkge1xyXG4gICAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIHdlYmNvbXBvbmVudHMtbG9hZGVyIGlzIGFscmVhZHkgcmVmZXJlbmNlZCBieSBwb2x5ZmlsbC5qcycpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbW9kaWZpZWRDb250ZW50ID0gY29udGVudEFzU3RyaW5nICsgJ1xcblxcbicgKyBzY3JpcHRzUG9seWZpbGxzO1xyXG5cclxuICAgIHRyZWUub3ZlcndyaXRlKGZpbGVOYW1lLCBtb2RpZmllZENvbnRlbnQpO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gZ2V0UHJvamVjdCh0cmVlOiBUcmVlLCBvcHRpb25zOiBhbnkpIHtcclxuICBjb25zdCB3b3Jrc3BhY2UgPSBnZXRXb3Jrc3BhY2UodHJlZSk7XHJcbiAgaWYgKCFvcHRpb25zLnByb2plY3QpIHtcclxuICAgIG9wdGlvbnMucHJvamVjdCA9IE9iamVjdC5rZXlzKHdvcmtzcGFjZS5wcm9qZWN0cylbMF07XHJcbiAgfVxyXG4gIGNvbnN0IHByb2plY3QgPSB3b3Jrc3BhY2UucHJvamVjdHNbb3B0aW9ucy5wcm9qZWN0XTtcclxuXHJcbiAgLy8gY29tcGVuc2F0ZSBmb3IgbGFja2luZyBzb3VyY2VSb290IHByb3BlcnR5XHJcbiAgLy8gZS4gZy4gd2hlbiBwcm9qZWN0IHdhcyBtaWdyYXRlZCB0byBuZzcsIHNvdXJjZVJvb3QgaXMgbGFja2luZ1xyXG4gIGlmICghcHJvamVjdC5zb3VyY2VSb290ICYmICFwcm9qZWN0LnJvb3QpIHtcclxuICAgIHByb2plY3Quc291cmNlUm9vdCA9ICdzcmMnO1xyXG4gIH1cclxuICBlbHNlIGlmICghcHJvamVjdC5zb3VyY2VSb290KSB7XHJcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSBwYXRoLmpvaW4ocHJvamVjdC5yb290LCAnc3JjJyk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcHJvamVjdDtcclxufVxyXG5cclxuZnVuY3Rpb24gc2F2ZVBhY2thZ2VKc29uKGNvbmZpZzogYW55LCB0cmVlOiBUcmVlKSB7XHJcbiAgY29uc3QgbmV3Q29udGVudEFzU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnLCBudWxsLCAyKSB8fCAnJztcclxuICB0cmVlLm92ZXJ3cml0ZSgncGFja2FnZS5qc29uJywgbmV3Q29udGVudEFzU3RyaW5nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZFBhY2thZ2VKc29uKHRyZWU6IFRyZWUpIHtcclxuICBjb25zdCBwa2cgPSB0cmVlLnJlYWQoJ3BhY2thZ2UuanNvbicpO1xyXG4gIGlmIChwa2cgPT09IG51bGwpXHJcbiAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgcGFja2FnZS5qc29uJyk7XHJcbiAgY29uc3QgY29udGVudEFzU3RyaW5nID0gcGtnLnRvU3RyaW5nKCdVVEYtOCcpO1xyXG4gIGNvbnN0IGNvbmZpZyA9IEpTT04ucGFyc2UoY29udGVudEFzU3RyaW5nKTtcclxuICByZXR1cm4gY29uZmlnO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVTY3JpcHRzKHBhdGg6IHN0cmluZywgY29uZmlnOiBhbnksIHRyZWU6IFRyZWUsIF9vcHRpb25zOiBhbnkpIHtcclxuICBcclxuICBpZiAocGF0aCkge1xyXG4gICAgcGF0aCArPSAnLyc7XHJcbiAgfVxyXG4gIFxyXG4gIGNvbnN0IHNjcmlwdCA9IGBub2RlICR7cGF0aH1jb3B5LXdjLXBvbHlmaWxsLmpzYDtcclxuXHJcbiAgaWYgKCFjb25maWdbJ3NjcmlwdHMnXSkge1xyXG4gICAgY29uZmlnLnNjcmlwdHMgPSB7fTtcclxuICB9XHJcblxyXG4gIGxldCBjdXJyZW50U2NyaXB0OiBzdHJpbmcgPSBjb25maWcuc2NyaXB0c1snbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnXTtcclxuXHJcbiAgaWYgKCFjdXJyZW50U2NyaXB0KSB7XHJcbiAgICBjdXJyZW50U2NyaXB0ID0gc2NyaXB0O1xyXG4gIH1cclxuICBlbHNlIGlmICghY3VycmVudFNjcmlwdC5pbmNsdWRlcyhzY3JpcHQpKSB7XHJcbiAgICBjdXJyZW50U2NyaXB0ICs9ICcgJiYgJyArIHNjcmlwdDtcclxuICB9XHJcblxyXG4gIGNvbmZpZy5zY3JpcHRzWyducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cyddID0gY3VycmVudFNjcmlwdDtcclxufVxyXG5cclxuIl19