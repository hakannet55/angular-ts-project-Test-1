"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const path = require("path");
const spawn = require('cross-spawn');
const scripts = `

  <!-- Here, all the shared code is imported -->
  <!-- consider creating one or several bundles -->
  <!-- for those -->

  <!-- core-js for legacy browsers 
        Consider only loading for IE
  -->
  <script src="./assets/core-js/core.js"></script>

  <!-- 
        Web Component polyfills
  -->
  <script src="/assets/webcomponentsjs/bundles/webcomponents-sd-ce.js"></script>

  <!-- Zone.js 
        Consider excluding zone.js when creating
        custom Elements by using the noop zone.

        If you load zone.js with an additional 
        bundle, delete this line.
  -->
  <script src="./assets/zone.js/zone.js"></script>

  <!-- TODO: Add further needed polyfills here ... -->

  <!-- Rx -->
  <script src="./assets/rxjs/rxjs.umd.js"></script>

  <!-- Angular Packages -->
  <script src="./assets/core/bundles/core.umd.js"></script>
  <script src="./assets/common/bundles/common.umd.js"></script>
  <script src="./assets/common/bundles/common-http.umd.js"></script>
  <script src="./assets/elements/bundles/elements.umd.js"></script>

  <script src="./assets/forms/bundles/forms.umd.js"></script>
  <script src="./assets/router/bundles/router.umd.js"></script>

  <!-- TODO: Add further needed Angular libs here ... -->

  <!-- Just needed for prod mode -->
  <script src="./assets/platform-browser/bundles/platform-browser.umd.js"></script>

`;
function addExternalsSupport(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        updateIndexHtml(_options, tree);
        // The host decides about prod mode 
        // when sharing deps
        if (!_options.host) {
            removeEnableProdModeInMainTs(_options, tree);
        }
        emptyPolyfillsTs(_options, tree);
        updatePackageJson(project.root || '', tree, _options);
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign(Object.assign({}, _options), { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        const rule = schematics_1.chain([
            schematics_1.branchAndMerge(schematics_1.mergeWith(templateSource))
        ]);
        const packageJson = loadPackageJson(tree);
        if ((!packageJson['dependencies'] || !packageJson['dependencies']['copy'])
            && (!packageJson['devDependencies'] || !packageJson['devDependencies']['copy'])) {
            const id = _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: 'copy',
            }));
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }), [id]);
        }
        else {
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }));
        }
        return rule(tree, _context);
    };
}
exports.addExternalsSupport = addExternalsSupport;
function updatePackageJson(path, tree, _options) {
    const config = loadPackageJson(tree);
    updateScripts(path, config, tree, _options);
    savePackageJson(config, tree);
}
function removeEnableProdModeInMainTs(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/main.ts`;
    const content = tree.read(fileName);
    if (content === null)
        throw Error('could not read main.ts');
    const contentAsString = content.toString('UTF-8');
    const modifiedContent = contentAsString.replace('enableProdMode();', '// Let the host app decide about prod mode\n  // enableProdMode();');
    tree.overwrite(fileName, modifiedContent);
}
function updateIndexHtml(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/index.html`;
    const indexHtml = tree.read(fileName);
    if (indexHtml === null)
        throw Error('could not read index.html');
    const contentAsString = indexHtml.toString('UTF-8');
    if (contentAsString.indexOf('.umd.js') > -1) {
        console.info('Seems like, UMD bundles are already referenced by index.html');
        return;
    }
    const modifiedContent = contentAsString.replace('</body>', scripts + '\n</body>');
    tree.overwrite(fileName, modifiedContent);
}
function emptyPolyfillsTs(options, tree) {
    const project = getProject(tree, options);
    const fileName = `${project.sourceRoot}/polyfills.ts`;
    const bakFileName = `${project.sourceRoot}/polyfills.ts.bak`;
    const content = tree.read(fileName);
    if (content === null)
        throw Error('could not read polyfills.ts');
    const contentAsString = content.toString('UTF-8');
    if (!tree.exists(bakFileName)) {
        tree.create(bakFileName, contentAsString);
    }
    tree.overwrite(fileName, `
// in extenals mode, polyfills are directly loaded into index.html
// to make sure everything is loaded in the right order
// the original contents of this file has been moved to polyfills.ts.bak
  `);
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options) {
    const project = getProject(tree, _options);
    if (!config['scripts']) {
        config.scripts = {};
    }
    const script = `node ${path}copy-bundles.js`;
    let copyAssetsScript = config.scripts['npx-build-plus:copy-assets'];
    if (!copyAssetsScript) {
        copyAssetsScript = script;
    }
    else if (!copyAssetsScript.includes(script)) {
        copyAssetsScript += ' && ' + script;
    }
    config.scripts['npx-build-plus:copy-assets'] = copyAssetsScript;
    let additionalFlags = '';
    if (!_options.host) {
        // external web components need single bundle w/ output hashing
        additionalFlags = '--single-bundle --output-hashing none';
    }
    // Heuristic for default project
    if (!project.root) {
        config.scripts['build:externals'] = `ng build --extra-webpack-config webpack.externals.js --prod ${additionalFlags}`;
    }
    if (_options.project) {
        config.scripts[`build:${_options.project}:externals`] = `ng build --extra-webpack-config webpack.externals.js --prod --project ${_options.project} ${additionalFlags}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3MvZXh0ZXJuYWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQXdJO0FBQ3hJLCtEQUFrRTtBQUNsRSw0REFBNEY7QUFDNUYsNkJBQTZCO0FBRTdCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUVyQyxNQUFNLE9BQU8sR0FBRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Q0E0Q2YsQ0FBQTtBQUVELFNBQWdCLG1CQUFtQixDQUFDLFFBQWE7SUFDL0MsT0FBTyxDQUFDLElBQVUsRUFBRSxRQUEwQixFQUFFLEVBQUU7UUFFaEQsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUzQyxNQUFNLGtCQUFrQixHQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXBELGVBQWUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEMsb0NBQW9DO1FBQ3BDLG9CQUFvQjtRQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtZQUNsQiw0QkFBNEIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUM7UUFFRCxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFakMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXRELE1BQU0sY0FBYyxHQUFHLGtCQUFLLENBQUMsZ0JBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMzQyxxQkFBUSxpQ0FBSyxRQUFRLEtBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRSxJQUFFO1lBQzVFLGlCQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUM7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxJQUFJLEdBQ1Isa0JBQUssQ0FBQztZQUNKLDJCQUFjLENBQUMsc0JBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUMxQyxDQUFDLENBQUM7UUFFSCxNQUFNLFdBQVcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFMUMsSUFDRSxDQUFDLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2VBQ25FLENBQUMsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQy9FO1lBRUYsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLDhCQUFzQixDQUFDO2dCQUNuRCxXQUFXLEVBQUUsTUFBTTthQUN0QixDQUFDLENBQUMsQ0FBQztZQUVKLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSx3QkFBZ0IsQ0FBQyxRQUFRLEVBQUUsRUFBQyxNQUFNLEVBQUUsNEJBQTRCLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUNoRzthQUNJO1lBQ0gsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLHdCQUFnQixDQUFDLFFBQVEsRUFBRSxFQUFDLE1BQU0sRUFBRSw0QkFBNEIsRUFBQyxDQUFDLENBQUMsQ0FBQztTQUMxRjtRQUNELE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM5QixDQUFDLENBQUM7QUFDSixDQUFDO0FBaERELGtEQWdEQztBQUVELFNBQVMsaUJBQWlCLENBQUMsSUFBWSxFQUFFLElBQVUsRUFBRSxRQUFhO0lBQ2hFLE1BQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyQyxhQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNoQyxDQUFDO0FBRUQsU0FBUyw0QkFBNEIsQ0FBQyxPQUFZLEVBQUUsSUFBVTtJQUM1RCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRTFDLE1BQU0sUUFBUSxHQUFHLEdBQUcsT0FBTyxDQUFDLFVBQVUsVUFBVSxDQUFDO0lBRWpELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEMsSUFBSSxPQUFPLEtBQUssSUFBSTtRQUNsQixNQUFNLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFbEQsTUFBTSxlQUFlLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxvRUFBb0UsQ0FBQyxDQUFDO0lBRTNJLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxPQUFZLEVBQUUsSUFBVTtJQUMvQyxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRTFDLE1BQU0sUUFBUSxHQUFHLEdBQUcsT0FBTyxDQUFDLFVBQVUsYUFBYSxDQUFDO0lBRXBELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEMsSUFBSSxTQUFTLEtBQUssSUFBSTtRQUNwQixNQUFNLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0lBQzNDLE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFcEQsSUFBSSxlQUFlLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO1FBQzNDLE9BQU8sQ0FBQyxJQUFJLENBQUMsOERBQThELENBQUMsQ0FBQztRQUM3RSxPQUFPO0tBQ1I7SUFFRCxNQUFNLGVBQWUsR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxPQUFPLEdBQUcsV0FBVyxDQUFDLENBQUM7SUFFbEYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsZUFBZSxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUdELFNBQVMsZ0JBQWdCLENBQUMsT0FBWSxFQUFFLElBQVU7SUFDaEQsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUUxQyxNQUFNLFFBQVEsR0FBRyxHQUFHLE9BQU8sQ0FBQyxVQUFVLGVBQWUsQ0FBQztJQUN0RCxNQUFNLFdBQVcsR0FBRyxHQUFHLE9BQU8sQ0FBQyxVQUFVLG1CQUFtQixDQUFDO0lBRTdELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEMsSUFBSSxPQUFPLEtBQUssSUFBSTtRQUNsQixNQUFNLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQzdDLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFbEQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7UUFDN0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUM7S0FDM0M7SUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRTs7OztHQUl4QixDQUFDLENBQUM7QUFDTCxDQUFDO0FBR0QsU0FBUyxVQUFVLENBQUMsSUFBVSxFQUFFLE9BQVk7SUFDMUMsTUFBTSxTQUFTLEdBQUcscUJBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtRQUNwQixPQUFPLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3REO0lBQ0QsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFcEQsNkNBQTZDO0lBQzdDLGdFQUFnRTtJQUNoRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDeEMsT0FBTyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7S0FDNUI7U0FDSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRTtRQUM1QixPQUFPLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztLQUNyRDtJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxNQUFXLEVBQUUsSUFBVTtJQUM5QyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDakUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsSUFBVTtJQUNqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3RDLElBQUksR0FBRyxLQUFLLElBQUk7UUFDZCxNQUFNLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQzdDLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzQyxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsSUFBWSxFQUFFLE1BQVcsRUFBRSxJQUFVLEVBQUUsUUFBYTtJQUN6RSxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRTNDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDdEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7S0FDckI7SUFFRCxNQUFNLE1BQU0sR0FBRyxRQUFRLElBQUksaUJBQWlCLENBQUM7SUFDN0MsSUFBSSxnQkFBZ0IsR0FBVyxNQUFNLENBQUMsT0FBTyxDQUFDLDRCQUE0QixDQUFDLENBQUM7SUFFNUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1FBQ3JCLGdCQUFnQixHQUFHLE1BQU0sQ0FBQztLQUMzQjtTQUNJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDM0MsZ0JBQWdCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQztLQUNyQztJQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsNEJBQTRCLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQztJQUVoRSxJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFFekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDbEIsK0RBQStEO1FBQy9ELGVBQWUsR0FBRyx1Q0FBdUMsQ0FBQztLQUMzRDtJQUVELGdDQUFnQztJQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRTtRQUNqQixNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsK0RBQStELGVBQWUsRUFBRSxDQUFDO0tBQ3RIO0lBRUQsSUFBSSxRQUFRLENBQUMsT0FBTyxFQUFFO1FBQ3BCLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxRQUFRLENBQUMsT0FBTyxZQUFZLENBQUMsR0FBRyx5RUFBeUUsUUFBUSxDQUFDLE9BQU8sSUFBSSxlQUFlLEVBQUUsQ0FBQztLQUN4SztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSdWxlLCBTY2hlbWF0aWNDb250ZXh0LCBUcmVlLCBhcHBseSwgdXJsLCB0ZW1wbGF0ZSwgbW92ZSwgYnJhbmNoQW5kTWVyZ2UsIG1lcmdlV2l0aCwgY2hhaW4gfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcyc7XHJcbmltcG9ydCB7IGdldFdvcmtzcGFjZSB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9jb25maWcnO1xyXG5pbXBvcnQgeyBSdW5TY2hlbWF0aWNUYXNrLCBOb2RlUGFja2FnZUluc3RhbGxUYXNrIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MvdGFza3MnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5cclxuY29uc3Qgc3Bhd24gPSByZXF1aXJlKCdjcm9zcy1zcGF3bicpO1xyXG5cclxuY29uc3Qgc2NyaXB0cyA9IGBcclxuXHJcbiAgPCEtLSBIZXJlLCBhbGwgdGhlIHNoYXJlZCBjb2RlIGlzIGltcG9ydGVkIC0tPlxyXG4gIDwhLS0gY29uc2lkZXIgY3JlYXRpbmcgb25lIG9yIHNldmVyYWwgYnVuZGxlcyAtLT5cclxuICA8IS0tIGZvciB0aG9zZSAtLT5cclxuXHJcbiAgPCEtLSBjb3JlLWpzIGZvciBsZWdhY3kgYnJvd3NlcnMgXHJcbiAgICAgICAgQ29uc2lkZXIgb25seSBsb2FkaW5nIGZvciBJRVxyXG4gIC0tPlxyXG4gIDxzY3JpcHQgc3JjPVwiLi9hc3NldHMvY29yZS1qcy9jb3JlLmpzXCI+PC9zY3JpcHQ+XHJcblxyXG4gIDwhLS0gXHJcbiAgICAgICAgV2ViIENvbXBvbmVudCBwb2x5ZmlsbHNcclxuICAtLT5cclxuICA8c2NyaXB0IHNyYz1cIi9hc3NldHMvd2ViY29tcG9uZW50c2pzL2J1bmRsZXMvd2ViY29tcG9uZW50cy1zZC1jZS5qc1wiPjwvc2NyaXB0PlxyXG5cclxuICA8IS0tIFpvbmUuanMgXHJcbiAgICAgICAgQ29uc2lkZXIgZXhjbHVkaW5nIHpvbmUuanMgd2hlbiBjcmVhdGluZ1xyXG4gICAgICAgIGN1c3RvbSBFbGVtZW50cyBieSB1c2luZyB0aGUgbm9vcCB6b25lLlxyXG5cclxuICAgICAgICBJZiB5b3UgbG9hZCB6b25lLmpzIHdpdGggYW4gYWRkaXRpb25hbCBcclxuICAgICAgICBidW5kbGUsIGRlbGV0ZSB0aGlzIGxpbmUuXHJcbiAgLS0+XHJcbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy96b25lLmpzL3pvbmUuanNcIj48L3NjcmlwdD5cclxuXHJcbiAgPCEtLSBUT0RPOiBBZGQgZnVydGhlciBuZWVkZWQgcG9seWZpbGxzIGhlcmUgLi4uIC0tPlxyXG5cclxuICA8IS0tIFJ4IC0tPlxyXG4gIDxzY3JpcHQgc3JjPVwiLi9hc3NldHMvcnhqcy9yeGpzLnVtZC5qc1wiPjwvc2NyaXB0PlxyXG5cclxuICA8IS0tIEFuZ3VsYXIgUGFja2FnZXMgLS0+XHJcbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9jb3JlL2J1bmRsZXMvY29yZS51bWQuanNcIj48L3NjcmlwdD5cclxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL2NvbW1vbi9idW5kbGVzL2NvbW1vbi51bWQuanNcIj48L3NjcmlwdD5cclxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL2NvbW1vbi9idW5kbGVzL2NvbW1vbi1odHRwLnVtZC5qc1wiPjwvc2NyaXB0PlxyXG4gIDxzY3JpcHQgc3JjPVwiLi9hc3NldHMvZWxlbWVudHMvYnVuZGxlcy9lbGVtZW50cy51bWQuanNcIj48L3NjcmlwdD5cclxuXHJcbiAgPHNjcmlwdCBzcmM9XCIuL2Fzc2V0cy9mb3Jtcy9idW5kbGVzL2Zvcm1zLnVtZC5qc1wiPjwvc2NyaXB0PlxyXG4gIDxzY3JpcHQgc3JjPVwiLi9hc3NldHMvcm91dGVyL2J1bmRsZXMvcm91dGVyLnVtZC5qc1wiPjwvc2NyaXB0PlxyXG5cclxuICA8IS0tIFRPRE86IEFkZCBmdXJ0aGVyIG5lZWRlZCBBbmd1bGFyIGxpYnMgaGVyZSAuLi4gLS0+XHJcblxyXG4gIDwhLS0gSnVzdCBuZWVkZWQgZm9yIHByb2QgbW9kZSAtLT5cclxuICA8c2NyaXB0IHNyYz1cIi4vYXNzZXRzL3BsYXRmb3JtLWJyb3dzZXIvYnVuZGxlcy9wbGF0Zm9ybS1icm93c2VyLnVtZC5qc1wiPjwvc2NyaXB0PlxyXG5cclxuYFxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZEV4dGVybmFsc1N1cHBvcnQoX29wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgX2NvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIFxyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgX29wdGlvbnMpO1xyXG5cclxuICAgIGNvbnN0IHJlbFByb2plY3RSb290UGF0aCA9IFxyXG4gICAgICAgICAgICBwcm9qZWN0LnJvb3QucmVwbGFjZSgvW15cXC9dKy9nLCAnLi4nKSB8fCAnJztcclxuXHJcbiAgICB1cGRhdGVJbmRleEh0bWwoX29wdGlvbnMsIHRyZWUpO1xyXG4gICAgXHJcbiAgICAvLyBUaGUgaG9zdCBkZWNpZGVzIGFib3V0IHByb2QgbW9kZSBcclxuICAgIC8vIHdoZW4gc2hhcmluZyBkZXBzXHJcbiAgICBpZiAoIV9vcHRpb25zLmhvc3QpIHtcclxuICAgICAgcmVtb3ZlRW5hYmxlUHJvZE1vZGVJbk1haW5Ucyhfb3B0aW9ucywgdHJlZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZW1wdHlQb2x5ZmlsbHNUcyhfb3B0aW9ucywgdHJlZSk7XHJcblxyXG4gICAgdXBkYXRlUGFja2FnZUpzb24ocHJvamVjdC5yb290IHx8ICcnLCB0cmVlLCBfb3B0aW9ucyk7XHJcbiAgICBcclxuICAgIGNvbnN0IHRlbXBsYXRlU291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzJyksIFtcclxuICAgICAgdGVtcGxhdGUoey4uLl9vcHRpb25zLCByZWxQcm9qZWN0Um9vdFBhdGgsIHByb2plY3RSb290OiBwcm9qZWN0LnJvb3QgfHwgJyd9KSxcclxuICAgICAgbW92ZShwcm9qZWN0LnJvb3QgfHwgJy8nKVxyXG4gICAgXSk7XHJcblxyXG4gICAgY29uc3QgcnVsZSA9IFxyXG4gICAgICBjaGFpbihbXHJcbiAgICAgICAgYnJhbmNoQW5kTWVyZ2UobWVyZ2VXaXRoKHRlbXBsYXRlU291cmNlKSlcclxuICAgICAgXSk7XHJcblxyXG4gICAgICBjb25zdCBwYWNrYWdlSnNvbiA9IGxvYWRQYWNrYWdlSnNvbih0cmVlKTtcclxuXHJcbiAgICAgIGlmIChcclxuICAgICAgICAoIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXSB8fCAhcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddWydjb3B5J10pIFxyXG4gICAgICAgICYmICghcGFja2FnZUpzb25bJ2RldkRlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGV2RGVwZW5kZW5jaWVzJ11bJ2NvcHknXSkgXHJcbiAgICAgICkge1xyXG4gIFxyXG4gICAgICBjb25zdCBpZCA9IF9jb250ZXh0LmFkZFRhc2sobmV3IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2soe1xyXG4gICAgICAgICAgcGFja2FnZU5hbWU6ICdjb3B5JyxcclxuICAgICAgfSkpO1xyXG4gIFxyXG4gICAgICBfY29udGV4dC5hZGRUYXNrKG5ldyBSdW5TY2hlbWF0aWNUYXNrKCducG1SdW4nLCB7c2NyaXB0OiAnbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnfSksIFtpZF0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIF9jb250ZXh0LmFkZFRhc2sobmV3IFJ1blNjaGVtYXRpY1Rhc2soJ25wbVJ1bicsIHtzY3JpcHQ6ICducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cyd9KSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcnVsZSh0cmVlLCBfY29udGV4dCk7XHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUGFja2FnZUpzb24ocGF0aDogc3RyaW5nLCB0cmVlOiBUcmVlLCBfb3B0aW9uczogYW55KSB7XHJcbiAgY29uc3QgY29uZmlnID0gbG9hZFBhY2thZ2VKc29uKHRyZWUpO1xyXG4gIHVwZGF0ZVNjcmlwdHMocGF0aCwgY29uZmlnLCB0cmVlLCBfb3B0aW9ucyk7XHJcbiAgc2F2ZVBhY2thZ2VKc29uKGNvbmZpZywgdHJlZSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlbW92ZUVuYWJsZVByb2RNb2RlSW5NYWluVHMob3B0aW9uczogYW55LCB0cmVlOiBUcmVlKSB7XHJcbiAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgb3B0aW9ucyk7XHJcblxyXG4gIGNvbnN0IGZpbGVOYW1lID0gYCR7cHJvamVjdC5zb3VyY2VSb290fS9tYWluLnRzYDtcclxuXHJcbiAgY29uc3QgY29udGVudCA9IHRyZWUucmVhZChmaWxlTmFtZSk7XHJcbiAgaWYgKGNvbnRlbnQgPT09IG51bGwpXHJcbiAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgbWFpbi50cycpO1xyXG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IGNvbnRlbnQudG9TdHJpbmcoJ1VURi04Jyk7XHJcbiAgXHJcbiAgY29uc3QgbW9kaWZpZWRDb250ZW50ID0gY29udGVudEFzU3RyaW5nLnJlcGxhY2UoJ2VuYWJsZVByb2RNb2RlKCk7JywgJy8vIExldCB0aGUgaG9zdCBhcHAgZGVjaWRlIGFib3V0IHByb2QgbW9kZVxcbiAgLy8gZW5hYmxlUHJvZE1vZGUoKTsnKTtcclxuXHJcbiAgdHJlZS5vdmVyd3JpdGUoZmlsZU5hbWUsIG1vZGlmaWVkQ29udGVudCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZUluZGV4SHRtbChvcHRpb25zOiBhbnksIHRyZWU6IFRyZWUpIHtcclxuICBjb25zdCBwcm9qZWN0ID0gZ2V0UHJvamVjdCh0cmVlLCBvcHRpb25zKTtcclxuXHJcbiAgY29uc3QgZmlsZU5hbWUgPSBgJHtwcm9qZWN0LnNvdXJjZVJvb3R9L2luZGV4Lmh0bWxgO1xyXG5cclxuICBjb25zdCBpbmRleEh0bWwgPSB0cmVlLnJlYWQoZmlsZU5hbWUpO1xyXG4gIGlmIChpbmRleEh0bWwgPT09IG51bGwpXHJcbiAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgaW5kZXguaHRtbCcpO1xyXG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IGluZGV4SHRtbC50b1N0cmluZygnVVRGLTgnKTtcclxuICBcclxuICBpZiAoY29udGVudEFzU3RyaW5nLmluZGV4T2YoJy51bWQuanMnKSA+IC0xKSB7XHJcbiAgICBjb25zb2xlLmluZm8oJ1NlZW1zIGxpa2UsIFVNRCBidW5kbGVzIGFyZSBhbHJlYWR5IHJlZmVyZW5jZWQgYnkgaW5kZXguaHRtbCcpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgbW9kaWZpZWRDb250ZW50ID0gY29udGVudEFzU3RyaW5nLnJlcGxhY2UoJzwvYm9keT4nLCBzY3JpcHRzICsgJ1xcbjwvYm9keT4nKTtcclxuXHJcbiAgdHJlZS5vdmVyd3JpdGUoZmlsZU5hbWUsIG1vZGlmaWVkQ29udGVudCk7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBlbXB0eVBvbHlmaWxsc1RzKG9wdGlvbnM6IGFueSwgdHJlZTogVHJlZSkge1xyXG4gIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIG9wdGlvbnMpO1xyXG5cclxuICBjb25zdCBmaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vcG9seWZpbGxzLnRzYDtcclxuICBjb25zdCBiYWtGaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vcG9seWZpbGxzLnRzLmJha2A7XHJcblxyXG4gIGNvbnN0IGNvbnRlbnQgPSB0cmVlLnJlYWQoZmlsZU5hbWUpO1xyXG4gIGlmIChjb250ZW50ID09PSBudWxsKVxyXG4gICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBvbHlmaWxscy50cycpO1xyXG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IGNvbnRlbnQudG9TdHJpbmcoJ1VURi04Jyk7XHJcbiAgXHJcbiAgaWYgKCF0cmVlLmV4aXN0cyhiYWtGaWxlTmFtZSkpIHtcclxuICAgIHRyZWUuY3JlYXRlKGJha0ZpbGVOYW1lLCBjb250ZW50QXNTdHJpbmcpO1xyXG4gIH1cclxuXHJcbiAgdHJlZS5vdmVyd3JpdGUoZmlsZU5hbWUsIGBcclxuLy8gaW4gZXh0ZW5hbHMgbW9kZSwgcG9seWZpbGxzIGFyZSBkaXJlY3RseSBsb2FkZWQgaW50byBpbmRleC5odG1sXHJcbi8vIHRvIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIGxvYWRlZCBpbiB0aGUgcmlnaHQgb3JkZXJcclxuLy8gdGhlIG9yaWdpbmFsIGNvbnRlbnRzIG9mIHRoaXMgZmlsZSBoYXMgYmVlbiBtb3ZlZCB0byBwb2x5ZmlsbHMudHMuYmFrXHJcbiAgYCk7XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBnZXRQcm9qZWN0KHRyZWU6IFRyZWUsIG9wdGlvbnM6IGFueSkge1xyXG4gIGNvbnN0IHdvcmtzcGFjZSA9IGdldFdvcmtzcGFjZSh0cmVlKTtcclxuICBpZiAoIW9wdGlvbnMucHJvamVjdCkge1xyXG4gICAgb3B0aW9ucy5wcm9qZWN0ID0gT2JqZWN0LmtleXMod29ya3NwYWNlLnByb2plY3RzKVswXTtcclxuICB9XHJcbiAgY29uc3QgcHJvamVjdCA9IHdvcmtzcGFjZS5wcm9qZWN0c1tvcHRpb25zLnByb2plY3RdO1xyXG5cclxuICAvLyBjb21wZW5zYXRlIGZvciBsYWNraW5nIHNvdXJjZVJvb3QgcHJvcGVydHlcclxuICAvLyBlLiBnLiB3aGVuIHByb2plY3Qgd2FzIG1pZ3JhdGVkIHRvIG5nNywgc291cmNlUm9vdCBpcyBsYWNraW5nXHJcbiAgaWYgKCFwcm9qZWN0LnNvdXJjZVJvb3QgJiYgIXByb2plY3Qucm9vdCkge1xyXG4gICAgcHJvamVjdC5zb3VyY2VSb290ID0gJ3NyYyc7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCFwcm9qZWN0LnNvdXJjZVJvb3QpIHtcclxuICAgIHByb2plY3Quc291cmNlUm9vdCA9IHBhdGguam9pbihwcm9qZWN0LnJvb3QsICdzcmMnKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBwcm9qZWN0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBzYXZlUGFja2FnZUpzb24oY29uZmlnOiBhbnksIHRyZWU6IFRyZWUpIHtcclxuICBjb25zdCBuZXdDb250ZW50QXNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShjb25maWcsIG51bGwsIDIpIHx8ICcnO1xyXG4gIHRyZWUub3ZlcndyaXRlKCdwYWNrYWdlLmpzb24nLCBuZXdDb250ZW50QXNTdHJpbmcpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkUGFja2FnZUpzb24odHJlZTogVHJlZSkge1xyXG4gIGNvbnN0IHBrZyA9IHRyZWUucmVhZCgncGFja2FnZS5qc29uJyk7XHJcbiAgaWYgKHBrZyA9PT0gbnVsbClcclxuICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBwYWNrYWdlLmpzb24nKTtcclxuICBjb25zdCBjb250ZW50QXNTdHJpbmcgPSBwa2cudG9TdHJpbmcoJ1VURi04Jyk7XHJcbiAgY29uc3QgY29uZmlnID0gSlNPTi5wYXJzZShjb250ZW50QXNTdHJpbmcpO1xyXG4gIHJldHVybiBjb25maWc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVNjcmlwdHMocGF0aDogc3RyaW5nLCBjb25maWc6IGFueSwgdHJlZTogVHJlZSwgX29wdGlvbnM6IGFueSkge1xyXG4gIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIF9vcHRpb25zKTtcclxuICBcclxuICBpZiAoIWNvbmZpZ1snc2NyaXB0cyddKSB7XHJcbiAgICBjb25maWcuc2NyaXB0cyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2NyaXB0ID0gYG5vZGUgJHtwYXRofWNvcHktYnVuZGxlcy5qc2A7XHJcbiAgbGV0IGNvcHlBc3NldHNTY3JpcHQ6IHN0cmluZyA9IGNvbmZpZy5zY3JpcHRzWyducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cyddO1xyXG5cclxuICBpZiAoIWNvcHlBc3NldHNTY3JpcHQpIHtcclxuICAgIGNvcHlBc3NldHNTY3JpcHQgPSBzY3JpcHQ7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCFjb3B5QXNzZXRzU2NyaXB0LmluY2x1ZGVzKHNjcmlwdCkpIHtcclxuICAgIGNvcHlBc3NldHNTY3JpcHQgKz0gJyAmJiAnICsgc2NyaXB0O1xyXG4gIH1cclxuXHJcbiAgY29uZmlnLnNjcmlwdHNbJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJ10gPSBjb3B5QXNzZXRzU2NyaXB0O1xyXG4gIFxyXG4gIGxldCBhZGRpdGlvbmFsRmxhZ3MgPSAnJztcclxuXHJcbiAgaWYgKCFfb3B0aW9ucy5ob3N0KSB7XHJcbiAgICAvLyBleHRlcm5hbCB3ZWIgY29tcG9uZW50cyBuZWVkIHNpbmdsZSBidW5kbGUgdy8gb3V0cHV0IGhhc2hpbmdcclxuICAgIGFkZGl0aW9uYWxGbGFncyA9ICctLXNpbmdsZS1idW5kbGUgLS1vdXRwdXQtaGFzaGluZyBub25lJztcclxuICB9XHJcblxyXG4gIC8vIEhldXJpc3RpYyBmb3IgZGVmYXVsdCBwcm9qZWN0XHJcbiAgaWYgKCFwcm9qZWN0LnJvb3QpIHtcclxuICAgIGNvbmZpZy5zY3JpcHRzWydidWlsZDpleHRlcm5hbHMnXSA9IGBuZyBidWlsZCAtLWV4dHJhLXdlYnBhY2stY29uZmlnIHdlYnBhY2suZXh0ZXJuYWxzLmpzIC0tcHJvZCAke2FkZGl0aW9uYWxGbGFnc31gO1xyXG4gIH1cclxuXHJcbiAgaWYgKF9vcHRpb25zLnByb2plY3QpIHtcclxuICAgIGNvbmZpZy5zY3JpcHRzW2BidWlsZDoke19vcHRpb25zLnByb2plY3R9OmV4dGVybmFsc2BdID0gYG5nIGJ1aWxkIC0tZXh0cmEtd2VicGFjay1jb25maWcgd2VicGFjay5leHRlcm5hbHMuanMgLS1wcm9kIC0tcHJvamVjdCAke19vcHRpb25zLnByb2plY3R9ICR7YWRkaXRpb25hbEZsYWdzfWA7XHJcbiAgfVxyXG59Il19